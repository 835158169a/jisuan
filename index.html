<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品计算网站</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background-color: #f9f9f9;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
            font-size: 16px;
        }
        .input-group input {
            width: calc(100% - 120px);
            padding: 10px;
            margin-left: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #007BFF;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        button {
            padding: 12px 24px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 15px;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.2s;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .delete-btn {
            background-color: #dc3545;
            padding: 6px 12px;
            font-size: 14px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .recalculate-btn {
            background-color: #ffc107;
            color: #212529;
            padding: 6px 12px;
            font-size: 14px;
        }
        .recalculate-btn:hover {
            background-color: #e0a800;
        }
        .history-btn {
            background-color: #6c757d;
            padding: 6px 12px;
            font-size: 14px;
        }
        .history-btn:hover {
            background-color: #5a6268;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-size: 16px;
        }
        td {
            font-size: 15px;
        }
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        .flex-left, .flex-right {
            flex: 1;
            min-width: 350px;
        }
        #copyNotification {
            color: green;
            margin-left: 15px;
            display: none;
            font-size: 16px;
        }
        .result-display {
            margin-top: 8px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            display: inline-block;
            font-size: 16px;
        }
        .editable-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable-cell:hover {
            background-color: #f9f9f9;
        }
        .editable-cell input {
            width: 90%;
            padding: 6px;
            text-align: center;
        }
        .recalculable-cell {
            cursor: pointer;
            color: #007BFF;
            text-decoration: underline;
            transition: color 0.2s;
        }
        .recalculable-cell:hover {
            color: #0056b3;
        }
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            transition: opacity 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        .modal-content:hover {
            transform: translateY(-2px);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            transition: color 0.2s;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-input-group {
            margin-bottom: 20px;
        }
        .modal-input-group label {
            display: inline-block;
            width: 100px;
            font-size: 16px;
        }
        .modal-input-group input {
            width: calc(100% - 120px);
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .modal-input-group input:focus {
            outline: none;
            border-color: #007BFF;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        h2 {
            font-size: 24px;
            margin-bottom: 25px;
        }
        h3 {
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .label-tag {
            font-size: 12px;
            color: #666;
            margin-left: 4px;
        }
        /* 历史记录面板样式 */
        #historyPanel {
            display: none;
            margin-top: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f8f9fa;
        }
        #historyTable {
            margin-top: 15px;
        }
        #historyTable th, #historyTable td {
            padding: 8px;
            font-size: 14px;
        }
        .history-date {
            font-size: 12px;
            color: #666;
        }
        .clear-history-btn {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            margin-top: 15px;
        }
        .clear-history-btn:hover {
            background-color: #c82333;
        }
        /* 新增的选择框样式 */
        .select-all-container {
            margin-bottom: 10px;
        }
        .restore-selected-btn {
            background-color: #28a745;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            margin-top: 15px;
        }
        .restore-selected-btn:hover {
            background-color: #218838;
        }
        .restore-btn {
            background-color: #28a745;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            margin-right: 5px;
        }
        .restore-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>产品计算工具</h2>
        
        <div class="flex-container">
            <!-- 左侧输入区域 -->
            <div class="flex-left">
                <div class="input-group">
                    <label for="productName">产品名称：</label>
                    <input type="text" id="productName" placeholder="输入产品名称">
                </div>
                <div class="input-group">
                    <label for="jinshu">斤数：<span class="label-tag">（系统）</span></label>
                    <input type="number" id="jinshu" placeholder="输入斤数">
                </div>
                <div class="input-group">
                    <label for="totalPrice">总单价：<span class="label-tag">（系统）</span></label>
                    <input type="number" id="totalPrice" placeholder="输入总单价">
                </div>
                <div class="input-group">
                    <label for="actualJinshu">实际斤数：<span class="label-tag">（客户）</span></label>
                    <input type="number" id="actualJinshu" placeholder="输入实际斤数">
                </div>
            </div>
            
            <!-- 右侧换算区域 -->
            <div class="flex-right">
                <div class="input-group">
                    <label for="keshu">克数：</label>
                    <input type="number" id="keshu" placeholder="输入克数">
                </div>
                <div class="input-group">
                    <label for="jin">斤：</label>
                    <input type="number" id="jin" placeholder="输入斤（如500）" value="500">
                </div>
                <div class="input-group">
                    <label>换算斤数：</label>
                    <span id="convertedJinshu" class="result-display">-</span>
                </div>
            </div>
        </div>

        <button onclick="calculate()">计算</button>
        <button onclick="resetForm()">重置</button>
        <button onclick="copyAllResults()">复制全部</button>
        <button onclick="toggleHistoryPanel()" class="history-btn">历史记录</button>
        <span id="copyNotification">复制成功！</span>

        <table id="resultTable" style="display: none;">
            <thead>
                <tr>
                    <th>序号</th>
                    <th>产品名称</th>
                    <th>实际斤数</th>
                    <th>价格计算</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="resultBody">
            </tbody>
            <tfoot id="resultFooter">
                <tr class="total-price-row">
                    <td colspan="3" class="total-price-label">总价：</td>
                    <td id="totalPriceDisplay">-</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        <!-- 历史记录面板 -->
        <div id="historyPanel">
            <h3>计算历史记录</h3>
            <div class="flex-container">
                <div class="flex-left">
                    <div class="input-group">
                        <label>搜索：</label>
                        <input type="text" id="historySearch" placeholder="输入产品名称搜索" oninput="filterHistory()">
                    </div>
                </div>
                <div class="flex-right">
                    <div class="input-group">
                        <label>排序：</label>
                        <select id="historySort" onchange="sortHistory()">
                            <option value="newest">最新优先</option>
                            <option value="oldest">最旧优先</option>
                            <option value="name">名称排序</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 新增的选择框区域 -->
            <div class="select-all-container">
                <label><input type="checkbox" id="selectAllHistory" onclick="toggleSelectAll()"> 全选</label>
                <button onclick="restoreSelectedRecords()" class="restore-selected-btn">还原选择</button>
            </div>
            
            <table id="historyTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="headerCheckbox" onclick="toggleSelectAll()"></th>
                        <th>序号</th>
                        <th>产品名称</th>
                        <th>实际斤数</th>
                        <th>价格</th>
                        <th>时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- 历史记录将通过JavaScript动态添加 -->
                </tbody>
            </table>
            <button onclick="clearAllHistory()" class="clear-history-btn">清空全部历史</button>
        </div>
    </div>

    <!-- 重新计算模态框 -->
    <div id="recalculateModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>重新计算产品价格</h3>
            <div class="modal-input-group">
                <label>产品名称：</label>
                <input type="text" id="modalProductName" disabled>
            </div>
            <div class="modal-input-group">
                <label>斤数：</label>
                <input type="number" id="modalJinshu">
            </div>
            <div class="modal-input-group">
                <label>总单价：</label>
                <input type="number" id="modalTotalPrice">
            </div>
            <div class="modal-input-group">
                <label>实际斤数：</label>
                <input type="number" id="modalActualJinshu">
            </div>
            <button onclick="recalculateItem()">确认计算</button>
            <button onclick="closeModal()">取消</button>
        </div>
    </div>

    <!-- 历史记录详情模态框 -->
    <div id="historyDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryDetailModal()">&times;</span>
            <h3>历史记录详情</h3>
            <div id="historyDetailContent">
                <!-- 详情内容将通过JavaScript动态添加 -->
            </div>
            <button onclick="useHistoryRecord()" class="recalculate-btn">使用此记录</button>
            <button onclick="closeHistoryDetailModal()">关闭</button>
        </div>
    </div>

    <script>
        let serialNumber = 1;
        let currentEditingCell = null;
        let currentRowIndex = -1;
        let currentHistoryItem = null; // 当前查看的历史记录项

        // 初始化斤的默认值为500
        document.getElementById('jin').value = 500;

        // 监听克数和斤的输入变化，实时计算换算斤数
        document.getElementById('keshu').addEventListener('input', updateConvertedJinshu);
        document.getElementById('jin').addEventListener('input', updateConvertedJinshu);

        // 更新换算斤数显示
        function updateConvertedJinshu() {
            const keshu = parseFloat(document.getElementById('keshu').value);
            const jin = parseFloat(document.getElementById('jin').value);
            
            if (!isNaN(keshu) && !isNaN(jin) && jin > 0) {
                const converted = keshu / jin;
                document.getElementById('convertedJinshu').textContent = converted.toFixed(2);
            } else {
                document.getElementById('convertedJinshu').textContent = '-';
            }
        }

        // 计算函数
        function calculate() {
            // 获取输入值
            const productName = document.getElementById('productName').value;
            const jinshu = parseFloat(document.getElementById('jinshu').value);
            const totalPrice = parseFloat(document.getElementById('totalPrice').value);
            const actualJinshu = parseFloat(document.getElementById('actualJinshu').value);
            const keshu = parseFloat(document.getElementById('keshu').value);
            const jin = parseFloat(document.getElementById('jin').value);

            // 验证输入
            if (!productName || isNaN(jinshu) || isNaN(totalPrice) || isNaN(actualJinshu)) {
                alert('请填写必要的产品信息（产品名称、斤数、总单价、实际斤数）');
                return;
            }

            // 计算逻辑
            const actualUnitPrice = totalPrice / jinshu; // 实际单价 = 总单价/斤数
            const finalUnitPrice = actualUnitPrice * actualJinshu; // 最终单价 = 实际单价*实际斤数
            const convertedJinshu = keshu / jin; // 换算斤数

            // 创建表格行
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="recalculable-cell" onclick="openRecalculateModal(${document.getElementById('resultBody').children.length})">${serialNumber}：</td>
                <td class="editable-cell" onclick="startEditing(this)">${productName}</td>
                <td>${actualJinshu}斤</td>
                <td>${totalPrice.toFixed(2)} ÷ ${jinshu} × ${actualJinshu} = ${finalUnitPrice.toFixed(2)}</td>
                <td><button class="delete-btn" onclick="deleteRow(this)">删除</button></td>
            `;

            // 保存产品数据到行的dataset
            row.dataset.productName = productName;
            row.dataset.jinshu = jinshu;
            row.dataset.totalPrice = totalPrice;
            row.dataset.actualJinshu = actualJinshu;
            row.dataset.actualUnitPrice = actualUnitPrice;
            row.dataset.finalUnitPrice = finalUnitPrice;

            // 添加到表格
            document.getElementById('resultBody').appendChild(row);
            document.getElementById('resultTable').style.display = 'table';

            // 保存历史记录
            saveHistoryRecord({
                id: Date.now(), // 使用时间戳作为唯一ID
                productName: productName,
                jinshu: jinshu,
                totalPrice: totalPrice,
                actualJinshu: actualJinshu,
                actualUnitPrice: actualUnitPrice,
                finalUnitPrice: finalUnitPrice,
                date: new Date().toLocaleString()
            });

            // 更新总价
            updateTotalPrice();

            // 序号自增
            serialNumber++;
        }

        // 重置函数
        function resetForm() {
            // 清空输入框
            document.getElementById('productName').value = '';
            document.getElementById('jinshu').value = '';
            document.getElementById('totalPrice').value = '';
            document.getElementById('actualJinshu').value = '';
            document.getElementById('keshu').value = '';
            document.getElementById('jin').value = 500;
            
            // 重置换算斤数显示
            document.getElementById('convertedJinshu').textContent = '-';

            // 清空结果表格
            document.getElementById('resultBody').innerHTML = '';
            document.getElementById('resultTable').style.display = 'none';

            // 重置序号
            serialNumber = 1;
            
            // 取消编辑状态
            stopEditing();
            closeModal();
            
            // 重置总价
            document.getElementById('totalPriceDisplay').textContent = '-';
        }

        // 复制全部结果 - 修复版
        function copyAllResults() {
            const table = document.getElementById('resultTable');
            const rows = table.querySelectorAll('tr');
            
            // 检查是否有数据行（排除表头和可能存在的表尾）
            if (rows.length <= 2) {
                alert('没有可复制的结果');
                return;
            }
            
            // 先完成可能正在进行的编辑
            stopEditing();
            closeModal();
            
            let textToCopy = '';
            
            // 遍历表格行（跳过表头和表尾）
            for (let i = 1; i < rows.length - 1; i++) {
                const cells = rows[i].querySelectorAll('td');
                let rowText = '';
                
                // 遍历单元格（排除操作列）
                for (let j = 0; j < cells.length - 1; j++) {
                    rowText += cells[j].textContent + ' ';
                }
                
                textToCopy += rowText.trim() + '\n';
            }
            
            // 添加总价行
            const footerRow = rows[rows.length - 1];
            const footerCells = footerRow.querySelectorAll('td');
            textToCopy += footerCells[0].textContent + ' ' + footerCells[1].textContent + ' ' + footerCells[2].textContent + ' ' + footerCells[3].textContent + '\n';
            
            // 使用现代剪贴板API复制文本
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    // 显示复制成功通知
                    const notification = document.getElementById('copyNotification');
                    notification.style.display = 'inline';
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 2000);
                })
                .catch(err => {
                    console.error('复制失败: ', err);
                    alert('复制失败，请重试');
                });
        }

        // 删除单行结果
        function deleteRow(button) {
            const row = button.closest('tr');
            
            // 如果删除的是正在编辑的行，先停止编辑
            if (currentEditingCell && row.contains(currentEditingCell)) {
                stopEditing();
            }
            
            row.remove();
            
            // 更新剩余行的序号和索引
            updateSerialNumbers();
            
            // 更新总价
            updateTotalPrice();
            
            // 如果表格为空，隐藏表格
            const tableBody = document.getElementById('resultBody');
            if (tableBody.children.length === 0) {
                document.getElementById('resultTable').style.display = 'none';
            }
        }
        
        // 更新表格中的序号
        function updateSerialNumbers() {
            const rows = document.getElementById('resultBody').querySelectorAll('tr');
            rows.forEach((row, index) => {
                const cell = row.querySelector('td:first-child');
                cell.textContent = `${index + 1}：`;
                cell.onclick = () => openRecalculateModal(index);
                
                // 更新行的索引
                row.dataset.index = index;
            });
        }

        // 开始编辑产品名称
        function startEditing(cell) {
            // 如果已经有正在编辑的单元格，先保存
            if (currentEditingCell) {
                stopEditing();
            }
            
            currentEditingCell = cell;
            const currentValue = cell.textContent;
            
            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.style.width = '90%';
            input.style.textAlign = 'center';
            
            // 清空单元格并添加输入框
            cell.innerHTML = '';
            cell.appendChild(input);
            
            // 聚焦到输入框
            input.focus();
            
            // 监听回车键和失去焦点事件
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    stopEditing();
                }
            });
            
            input.addEventListener('blur', stopEditing);
        }

        // 停止编辑并保存
        function stopEditing() {
            if (!currentEditingCell) return;
            
            const input = currentEditingCell.querySelector('input');
            if (input) {
                const newValue = input.value.trim();
                if (newValue) {
                    currentEditingCell.textContent = newValue;
                    
                    // 更新行的dataset中的产品名称
                    const row = currentEditingCell.closest('tr');
                    if (row) {
                        row.dataset.productName = newValue;
                    }
                }
            }
            
            // 添加双击事件监听器
            currentEditingCell.addEventListener('dblclick', function() {
                startEditing(this);
            });
            
            currentEditingCell = null;
        }

        // 打开重新计算模态框
        function openRecalculateModal(index) {
            const rows = document.getElementById('resultBody').querySelectorAll('tr');
            if (index >= 0 && index < rows.length) {
                const row = rows[index];
                currentRowIndex = index;
                
                // 填充模态框数据
                document.getElementById('modalProductName').value = row.dataset.productName;
                document.getElementById('modalJinshu').value = row.dataset.jinshu;
                document.getElementById('modalTotalPrice').value = row.dataset.totalPrice;
                document.getElementById('modalActualJinshu').value = row.dataset.actualJinshu;
                
                // 显示模态框
                document.getElementById('recalculateModal').style.display = 'block';
            }
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('recalculateModal').style.display = 'none';
            currentRowIndex = -1;
        }

        // 重新计算单行结果
        function recalculateItem() {
            const rows = document.getElementById('resultBody').querySelectorAll('tr');
            if (currentRowIndex >= 0 && currentRowIndex < rows.length) {
                const row = rows[currentRowIndex];
                
                // 获取模态框中的值
                const jinshu = parseFloat(document.getElementById('modalJinshu').value);
                const totalPrice = parseFloat(document.getElementById('modalTotalPrice').value);
                const actualJinshu = parseFloat(document.getElementById('modalActualJinshu').value);
                
                // 验证输入
                if (isNaN(jinshu) || isNaN(totalPrice) || isNaN(actualJinshu)) {
                    alert('请输入有效的数值');
                    return;
                }
                
                // 计算新的价格
                const actualUnitPrice = totalPrice / jinshu;
                const finalUnitPrice = actualUnitPrice * actualJinshu;
                
                // 更新表格行
                row.dataset.jinshu = jinshu;
                row.dataset.totalPrice = totalPrice;
                row.dataset.actualJinshu = actualJinshu;
                row.dataset.actualUnitPrice = actualUnitPrice;
                row.dataset.finalUnitPrice = finalUnitPrice;
                
                // 更新表格显示
                row.querySelector('td:nth-child(3)').textContent = `${actualJinshu}斤`;
                row.querySelector('td:nth-child(4)').textContent = `${totalPrice.toFixed(2)} ÷ ${jinshu} × ${actualJinshu} = ${finalUnitPrice.toFixed(2)}`;
                
                // 更新总价
                updateTotalPrice();
                
                // 关闭模态框
                closeModal();
            }
        }

        // 历史记录功能
        function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                loadHistoryRecords();
            } else {
                panel.style.display = 'none';
            }
        }

        // 保存历史记录
        function saveHistoryRecord(record) {
            // 从localStorage获取现有历史记录
            let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            
            // 添加新记录到开头
            history.unshift(record);
            
            // 限制历史记录数量为100条
            if (history.length > 100) {
                history = history.slice(0, 100);
            }
            
            // 保存回localStorage
            localStorage.setItem('calculationHistory', JSON.stringify(history));
            
            // 如果历史面板已打开，则刷新显示
            if (document.getElementById('historyPanel').style.display === 'block') {
                loadHistoryRecords();
            }
        }

        // 加载历史记录
        function loadHistoryRecords() {
            const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            const historyBody = document.getElementById('historyBody');
            
            // 清空当前历史记录
            historyBody.innerHTML = '';
            
            // 如果没有历史记录，显示提示
            if (history.length === 0) {
                historyBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">没有历史记录</td>
                    </tr>
                `;
                return;
            }
            
            // 显示历史记录
            history.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="history-checkbox" data-index="${index}"></td>
                    <td>${index + 1}</td>
                    <td onclick="viewHistoryDetail(${index})">${record.productName}</td>
                    <td>${record.actualJinshu}斤</td>
                    <td>${record.finalUnitPrice.toFixed(2)}</td>
                    <td class="history-date">${record.date}</td>
                    <td>
                        <button onclick="restoreRecord(${index})" class="restore-btn">还原</button>
                        <button onclick="deleteHistoryRecord(${index})" class="delete-btn">删除</button>
                    </td>
                `;
                historyBody.appendChild(row);
            });
            
            // 重置全选框状态
            document.getElementById('selectAllHistory').checked = false;
            document.getElementById('headerCheckbox').checked = false;
        }

        // 删除单条历史记录
        function deleteHistoryRecord(index) {
            if (confirm('确定要删除这条历史记录吗？')) {
                let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                history.splice(index, 1);
                localStorage.setItem('calculationHistory', JSON.stringify(history));
                loadHistoryRecords();
            }
        }

        // 清空全部历史记录
        function clearAllHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复！')) {
                localStorage.removeItem('calculationHistory');
                loadHistoryRecords();
            }
        }

        // 查看历史记录详情
        function viewHistoryDetail(index) {
            const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            if (index >= 0 && index < history.length) {
                currentHistoryItem = history[index];
                
                const detailContent = `
                    <div class="modal-input-group">
                        <label>产品名称：</label>
                        <span>${currentHistoryItem.productName}</span>
                    </div>
                    <div class="modal-input-group">
                        <label>斤数：</label>
                        <span>${currentHistoryItem.jinshu}</span>
                    </div>
                    <div class="modal-input-group">
                        <label>总单价：</label>
                        <span>${currentHistoryItem.totalPrice}</span>
                    </div>
                    <div class="modal-input-group">
                        <label>实际斤数：</label>
                        <span>${currentHistoryItem.actualJinshu}斤</span>
                    </div>
                    <div class="modal-input-group">
                        <label>实际单价：</label>
                        <span>${currentHistoryItem.actualUnitPrice.toFixed(2)}</span>
                    </div>
                    <div class="modal-input-group">
                        <label>最终价格：</label>
                        <span>${currentHistoryItem.finalUnitPrice.toFixed(2)}</span>
                    </div>
                    <div class="modal-input-group">
                        <label>计算时间：</label>
                        <span>${currentHistoryItem.date}</span>
                    </div>
                `;
                
                document.getElementById('historyDetailContent').innerHTML = detailContent;
                document.getElementById('historyDetailModal').style.display = 'block';
            }
        }

        // 关闭历史详情模态框
        function closeHistoryDetailModal() {
            document.getElementById('historyDetailModal').style.display = 'none';
            currentHistoryItem = null;
        }

        // 使用历史记录
        function useHistoryRecord() {
            if (currentHistoryItem) {
                document.getElementById('productName').value = currentHistoryItem.productName;
                document.getElementById('jinshu').value = currentHistoryItem.jinshu;
                document.getElementById('totalPrice').value = currentHistoryItem.totalPrice;
                document.getElementById('actualJinshu').value = currentHistoryItem.actualJinshu;
                
                closeHistoryDetailModal();
            }
        }

        // 过滤历史记录
        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            const historyBody = document.getElementById('historyBody');
            
            // 清空当前历史记录
            historyBody.innerHTML = '';
            
            // 过滤历史记录
            const filteredHistory = history.filter(record => 
                record.productName.toLowerCase().includes(searchTerm)
            );
            
            // 如果没有匹配的记录，显示提示
            if (filteredHistory.length === 0) {
                historyBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">没有找到匹配的历史记录</td>
                    </tr>
                `;
                return;
            }
            
            // 显示过滤后的历史记录
            filteredHistory.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="history-checkbox" data-index="${history.indexOf(record)}"></td>
                    <td>${index + 1}</td>
                    <td onclick="viewHistoryDetail(history.indexOf(record))">${record.productName}</td>
                    <td>${record.actualJinshu}斤</td>
                    <td>${record.finalUnitPrice.toFixed(2)}</td>
                    <td class="history-date">${record.date}</td>
                    <td>
                        <button onclick="restoreRecord(history.indexOf(record))" class="restore-btn">还原</button>
                        <button onclick="deleteHistoryRecord(history.indexOf(record))" class="delete-btn">删除</button>
                    </td>
                `;
                historyBody.appendChild(row);
            });
            
            // 重置全选框状态
            document.getElementById('selectAllHistory').checked = false;
            document.getElementById('headerCheckbox').checked = false;
        }

        // 排序历史记录
        function sortHistory() {
            const sortMethod = document.getElementById('historySort').value;
            let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            
            // 根据选择的排序方式排序
            switch (sortMethod) {
                case 'newest':
                    history.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'oldest':
                    history.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'name':
                    history.sort((a, b) => a.productName.localeCompare(b.productName));
                    break;
            }
            
            // 保存排序后的历史记录
            localStorage.setItem('calculationHistory', JSON.stringify(history));
            
            // 重新加载历史记录
            loadHistoryRecords();
        }

        // 更新总价
        function updateTotalPrice() {
            const rows = document.getElementById('resultBody').querySelectorAll('tr');
            let totalPrice = 0;
            
            rows.forEach(row => {
                const finalUnitPrice = parseFloat(row.dataset.finalUnitPrice);
                if (!isNaN(finalUnitPrice)) {
                    totalPrice += finalUnitPrice;
                }
            });
            
            document.getElementById('totalPriceDisplay').textContent = totalPrice.toFixed(2);
        }

        // 全选/取消全选历史记录
        function toggleSelectAll() {
            const isChecked = document.getElementById('selectAllHistory').checked;
            const checkboxes = document.querySelectorAll('.history-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            // 同步表头复选框状态
            document.getElementById('headerCheckbox').checked = isChecked;
        }

        // 还原单条历史记录
        function restoreRecord(index) {
            const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            if (index >= 0 && index < history.length) {
                const record = history[index];
                
                // 创建表格行
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="recalculable-cell" onclick="openRecalculateModal(${document.getElementById('resultBody').children.length})">${serialNumber}：</td>
                    <td class="editable-cell" onclick="startEditing(this)">${record.productName}</td>
                    <td>${record.actualJinshu}斤</td>
                    <td>${record.totalPrice.toFixed(2)} ÷ ${record.jinshu} × ${record.actualJinshu} = ${record.finalUnitPrice.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteRow(this)">删除</button></td>
                `;

                // 保存产品数据到行的dataset
                row.dataset.productName = record.productName;
                row.dataset.jinshu = record.jinshu;
                row.dataset.totalPrice = record.totalPrice;
                row.dataset.actualJinshu = record.actualJinshu;
                row.dataset.actualUnitPrice = record.actualUnitPrice;
                row.dataset.finalUnitPrice = record.finalUnitPrice;

                // 添加到表格
                document.getElementById('resultBody').appendChild(row);
                document.getElementById('resultTable').style.display = 'table';

                // 更新总价
                updateTotalPrice();

                // 序号自增
                serialNumber++;
                
                // 如果历史面板打开，刷新历史记录（更新序号）
                if (document.getElementById('historyPanel').style.display === 'block') {
                    loadHistoryRecords();
                }
            }
        }

        // 还原选择的历史记录
        function restoreSelectedRecords() {
            const checkboxes = document.querySelectorAll('.history-checkbox:checked');
            const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            
            if (checkboxes.length === 0) {
                alert('请先选择要还原的历史记录');
                return;
            }
            
            // 按索引排序，确保按顺序还原
            const selectedIndices = Array.from(checkboxes).map(checkbox => 
                parseInt(checkbox.dataset.index)
            ).sort((a, b) => a - b);
            
            // 还原选中的记录
            selectedIndices.forEach(index => {
                if (index >= 0 && index < history.length) {
                    const record = history[index];
                    
                    // 创建表格行
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="recalculable-cell" onclick="openRecalculateModal(${document.getElementById('resultBody').children.length})">${serialNumber}：</td>
                        <td class="editable-cell" onclick="startEditing(this)">${record.productName}</td>
                        <td>${record.actualJinshu}斤</td>
                        <td>${record.totalPrice.toFixed(2)} ÷ ${record.jinshu} × ${record.actualJinshu} = ${record.finalUnitPrice.toFixed(2)}</td>
                        <td><button class="delete-btn" onclick="deleteRow(this)">删除</button></td>
                    `;

                    // 保存产品数据到行的dataset
                    row.dataset.productName = record.productName;
                    row.dataset.jinshu = record.jinshu;
                    row.dataset.totalPrice = record.totalPrice;
                    row.dataset.actualJinshu = record.actualJinshu;
                    row.dataset.actualUnitPrice = record.actualUnitPrice;
                    row.dataset.finalUnitPrice = record.finalUnitPrice;

                    // 添加到表格
                    document.getElementById('resultBody').appendChild(row);
                    document.getElementById('resultTable').style.display = 'table';

                    // 更新总价
                    updateTotalPrice();

                    // 序号自增
                    serialNumber++;
                }
            });
            
            // 如果历史面板打开，刷新历史记录（更新序号）
            if (document.getElementById('historyPanel').style.display === 'block') {
                loadHistoryRecords();
            }
        }

        // 初始化表格中的产品名称双击编辑功能
        document.addEventListener('DOMContentLoaded', function() {
            // 为已存在的单元格添加双击事件
            const tableBody = document.getElementById('resultBody');
            tableBody.addEventListener('dblclick', function(e) {
                if (e.target && e.target.classList.contains('editable-cell')) {
                    startEditing(e.target);
                }
            });
            
            // 为模态框添加关闭功能
            document.querySelector('.close').addEventListener('click', closeModal);
            
            // 点击模态框外部关闭
            document.getElementById('recalculateModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // 键盘ESC关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeHistoryDetailModal();
                }
            });
            
            // 点击历史详情模态框外部关闭
            document.getElementById('historyDetailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeHistoryDetailModal();
                }
            });
            
            // 初始化时加载历史记录（如果面板是打开的）
            if (document.getElementById('historyPanel').style.display === 'block') {
                loadHistoryRecords();
            }
        });
    </script>
</body>
</html>
